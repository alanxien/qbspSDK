package com.chuannuo.tangguo;


import org.json.JSONObject;

import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.provider.Settings.Secure;

import com.chuannuo.tangguo.listener.AddPointListener;
import com.chuannuo.tangguo.listener.GetTotalPointListener;
import com.chuannuo.tangguo.listener.ResponseStateListener;
import com.chuannuo.tangguo.listener.SpendPointListener;
import com.chuannuo.tangguo.listener.TangGuoWallListener;
import com.chuannuo.tangguo.task.AddPointTask;
import com.chuannuo.tangguo.task.SpendPointTask;

/** 
 * TODO<请描述这个类是干什么的> 
 * @author  xie.xin 
 * @data:  2015-7-1 下午10:56:32 
 * @version:  V1.0 
 */
public class TangGuoWall {
	
	private static Context context;
	private static String theme ;
	public static TangGuoWallListener tangGuoWallListener;
	private static SharedPreferences pref;
	private static String USERID;

	/** 
	* @Title: initWall 
	* @Description: TODO
	* @param @param ctx
	* @param @param id
	* @return void 
	* @throws 
	*/
	public static void initWall(Context ctx,String id){
		context = ctx;
		if (null == pref) {
			pref = context.getSharedPreferences(Constant.PREF_QIANBAO_SDK,
					Context.MODE_PRIVATE);
		}
		USERID = id;
	}
	
	public static String getUserId(){
		return USERID;
	}

	public static void setTangGuoWallListener(TangGuoWallListener listener) {
		tangGuoWallListener = listener;
	}

	/** 
	* @Title: show 
	* @Description: TODO
	* @param 
	* @return void 
	* @throws 
	*/
	public static void show(){
		Intent intent = new Intent();
		intent.putExtra("color", theme);
		intent.setClass(context, TangGuoActivity.class);
		context.startActivity(intent);
	}
	
	/** 
	* @Title: setColor 
	* @Description: 设置主题
	* @param @param color
	* @return void 
	* @throws 
	*/
	public static void setColor(String color){
		theme = color;
	}
	
	/** 
	* @Title: getTotalPoint 
	* @Description: 获取虚拟货币总额
	* @param @return
	* @return int 
	* @throws 
	*/
	public static void getTotalPoint(final GetTotalPointListener listener){
		HttpUtil.setParams("id", pref.getString(Constant.APP_ID, "0"));
		HttpUtil.setParams("channel_id", PhoneInformation.getMetaData(context, Constant.TANGGUO_APPID));
		new SpendPointTask().execute(Constant.URL.USER_INFO_URL,new ResponseStateListener() {

			@Override
			public void onSuccess(Object result) {
				try {
					if (null != result
							&& !result
									.equals(Constant.NET_ERROR)) {
						JSONObject jsonObject;
						jsonObject = new JSONObject(result
								.toString());
						String code = jsonObject
								.getString("code");
						JSONObject data = jsonObject.getJSONObject("data");
						if (code.equals("1")) {
							
							if(null != data){
								listener.getTotalPoint(Constant.ACCESS_SUCCESS, data.getString("txt_name"),data.getInt("integral"));
							}else{
								listener.getTotalPoint(Constant.ACCESS_FAILURE,"", 0);
							}
							
						}else{
							listener.getTotalPoint(Constant.ACCESS_FAILURE,"", 0);
						}
					}else{
						listener.getTotalPoint(Constant.ACCESS_FAILURE,"", 0);
					}
				} catch (Exception e) {
					// TODO: handle exception
				}

			};
		});

	}
	
	/** 
	* @Title: spendPoint 
	* @Description: 消费虚拟货币
	* @param @param listener
	* @return void 
	* @throws 
	*/
	public static void spendPoint(final int point,final SpendPointListener listener){
		HttpUtil.setParams("appid", pref.getString(Constant.APP_ID, "0"));
		HttpUtil.setParams("code", pref.getString(Constant.CODE, "0"));
		HttpUtil.setParams("integral", point+"");
		HttpUtil.setParams("key", PhoneInformation.getMetaData(context, Constant.TANGGUO_APPKEY));
		HttpUtil.setParams("channel_id", PhoneInformation.getMetaData(context, Constant.TANGGUO_APPID));
		PhoneInformation.initTelephonyManager(context);
		HttpUtil.setParams("imei", PhoneInformation.getImei());
		HttpUtil.setParams("imsi", PhoneInformation.getImsi());
		HttpUtil.setParams("machineType", PhoneInformation.getMachineType());
		HttpUtil.setParams("net_type", PhoneInformation.getNetType()+"");
		HttpUtil.setParams("macaddress", PhoneInformation.getMacAddress());
		HttpUtil.setParams("androidid",Secure.getString(context.getContentResolver(),Secure.ANDROID_ID));
	
		new SpendPointTask().execute(Constant.URL.EXCHANGE_URL,
				new ResponseStateListener() {

					@Override
					public void onSuccess(Object result) {
						try {
							if (null != result
									&& !result
											.equals(Constant.NET_ERROR)) {
								JSONObject jsonObject;
								jsonObject = new JSONObject(result
										.toString());
								String code = jsonObject
										.getString("code");
								if (code.equals("1")) {
									listener.spendPoint(Constant.ACCESS_SUCCESS, point);
								}else{
									listener.spendPoint(Constant.ACCESS_FAILURE,point);
								}
							}else{
								listener.spendPoint(Constant.ACCESS_FAILURE,point);
							}
						} catch (Exception e) {
							// TODO: handle exception
						}

					};
				});
	}
	
	/** 
	* @Title: addPoint 
	* @Description: 客户端增加积分
	* @param @param point
	* @param @param listener
	* @return void 
	* @throws 
	*/
	public static void addPoint(final int point,final AddPointListener listener){
		HttpUtil.setParams("appid", pref.getString(Constant.APP_ID, "0"));
		HttpUtil.setParams("code", pref.getString(Constant.CODE, "0"));
		HttpUtil.setParams("integral", point+"");
		HttpUtil.setParams("key", PhoneInformation.getMetaData(context, Constant.TANGGUO_APPKEY));
		HttpUtil.setParams("channel_id", PhoneInformation.getMetaData(context, Constant.TANGGUO_APPID));
		PhoneInformation.initTelephonyManager(context);
		HttpUtil.setParams("imei", PhoneInformation.getImei());
		HttpUtil.setParams("imsi", PhoneInformation.getImsi());
		HttpUtil.setParams("machineType", PhoneInformation.getMachineType());
		HttpUtil.setParams("net_type", PhoneInformation.getNetType()+"");
		HttpUtil.setParams("macaddress", PhoneInformation.getMacAddress());
		HttpUtil.setParams("androidid",Secure.getString(context.getContentResolver(),Secure.ANDROID_ID));
	
		new AddPointTask().execute(Constant.URL.EXCHANGE_ADD_URL,
				new ResponseStateListener() {

					@Override
					public void onSuccess(Object result) {
						try {
							if (null != result
									&& !result
											.equals(Constant.NET_ERROR)) {
								JSONObject jsonObject;
								jsonObject = new JSONObject(result
										.toString());
								String code = jsonObject
										.getString("code");
								if (code.equals("1")) {
									listener.addPoint(Constant.ACCESS_SUCCESS, point);
								}else{
									listener.addPoint(Constant.ACCESS_FAILURE,point);
								}
							}else{
								listener.addPoint(Constant.ACCESS_FAILURE,point);
							}
						} catch (Exception e) {
							// TODO: handle exception
						}

					};
				});
	}
}
